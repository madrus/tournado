---
description: Implement Firebase session cookie bridging for SSR compatibility
id: "TASK-0102"
title: "Implement Firebase session cookie bridging for SSR compatibility"
status: "done"
priority: "P0"
labels: ["auth", "firebase", "ssr", "session"]
dependencies: ["./TASK-0101-firebase-auth-setup.mdc"]
created: "2025-01-09"
globs:
alwaysApply: false
---

# INSTRUCTIONS â€” READ THIS FIRST WHEN STARTING THE TASK

Follow the file creation safety and TypeScript conventions in `.cursor/tasks/task-template.mdc`.

## ARCHITECTURE DECISION RECORDS

### ðŸŽ¯ **FEATURE Task** - Self-contained business domain
**Decision**: Session bridging extends the Firebase feature with server-side session management capabilities. This remains within the Firebase feature boundary as it's core to Firebase authentication functionality and maintains the feature's cohesion.

**Rationale**:
- Session bridging is tightly coupled to Firebase authentication logic
- Extends Firebase feature without creating new business domain
- Maintains single responsibility for Firebase-related authentication concerns
- Server-side session management is implementation detail of Firebase auth integration

# 1) High-Level Objective

Bridge Firebase authentication with server-side session management to maintain SSR compatibility and existing route protection patterns.

# 2) Background / Context

Phase 1 of authentication modernization requires seamless integration between Firebase client authentication and existing server-side session management. This task implements session cookie bridging that allows Firebase ID tokens to be converted to server sessions while preserving existing role-based access control and SSR functionality.

Reference: PRD Phase 1 - Authentication Modernization (Critical Priority)

# 3) Assumptions & Constraints

- ASSUMPTION: Firebase setup from TASK-0101 is complete and functional
- Constraint: Must preserve existing session.server.ts API for backward compatibility
- Constraint: Maintain existing role-based access control (ADMIN, MANAGER, REFEREE, PUBLIC)
- Constraint: No breaking changes to existing route loaders that use requireUserId/getUserId
- Constraint: Session cookies must work with existing commitSession/getSession patterns

# 4) Dependencies (Other Tasks or Artifacts)

- ./TASK-0101-firebase-auth-setup.mdc (Firebase configuration must be complete)
- app/utils/session.server.ts (existing session utilities)
- app/utils/rbacMiddleware.server.ts (existing RBAC middleware)
- app/models/user.server.ts (existing User model operations)

# 5) Context Plan

## ðŸŽ¯ FEATURE Task Pattern
**Beginning (add to model context):**
- app/features/firebase/server.ts _(from TASK-0101, read-only)_
- app/utils/session.server.ts _(read-only)_
- app/utils/rbacMiddleware.server.ts _(read-only)_
- app/models/user.server.ts _(read-only)_
- prisma/schema.prisma _(read-only)_

**End state (files that will be created/modified):**
- app/features/firebase/index.ts _(feature public API updated)_
- app/features/firebase/auth.server.ts
- app/features/firebase/session.server.ts
- app/features/firebase/__tests__/ _(test files as needed)_
- Updated app/utils/session.server.ts with Firebase integration
- Updated app/utils/__tests__/session.server.test.ts

# 6) Low-Level Steps (Ordered, information-dense)

1. **Create Firebase session bridge utilities**

   - File: `app/features/firebase/session.server.ts`
   - Exported API:
     ```ts
     type CreateSessionFromFirebaseTokenProps = {
       idToken: string
       request: Request
     }

     type SyncFirebaseUserToDatabaseProps = {
       firebaseUser: DecodedIdToken
     }

     type ValidateFirebaseSessionProps = {
       request: Request
     }

     export async function createSessionFromFirebaseToken(
       props: Readonly<CreateSessionFromFirebaseTokenProps>
     ): Promise<{ session: Session; user: User } | null>

     export async function syncFirebaseUserToDatabase(
       props: Readonly<SyncFirebaseUserToDatabaseProps>
     ): Promise<User>

     export async function validateFirebaseSession(
       props: Readonly<ValidateFirebaseSessionProps>
     ): Promise<{ user: User; session: Session } | null>
     ```
   - Details:
     - Verify Firebase ID token using admin SDK
     - Create or update User record in database
     - Generate session cookie with user data
     - Handle Firebase user email/displayName sync

2. **Create auth server utilities**

   - File: `app/features/firebase/auth.server.ts`
   - Exported API:
     ```ts
     type AuthenticateFirebaseUserProps = {
       request: Request
     }

     type RequireFirebaseAuthProps = {
       request: Request
       redirectTo?: string
     }

     type GetFirebaseUserProps = {
       request: Request
     }

     export async function authenticateFirebaseUser(
       props: Readonly<AuthenticateFirebaseUserProps>
     ): Promise<User | null>

     export async function requireFirebaseAuth(
       props: Readonly<RequireFirebaseAuthProps>
     ): Promise<User>

     export async function getFirebaseUser(
       props: Readonly<GetFirebaseUserProps>
     ): Promise<User | null>
     ```
   - Details:
     - High-level authentication functions
     - Integrate with existing session patterns
     - Maintain backward compatibility with existing auth functions
     - Handle redirect logic for unauthenticated users

3. **Update existing session utilities**

   - File: `app/utils/session.server.ts`
   - Update functions:
     ```ts
     // Enhanced to support Firebase sessions
     export async function getUserId(request: Request): Promise<string | undefined>
     export async function requireUserId(request: Request, redirectTo?: string): Promise<string>
     export async function getUser(request: Request): Promise<User | null>
     export async function requireUser(request: Request, redirectTo?: string): Promise<User>

     // New Firebase-specific functions
     export async function createFirebaseUserSession({
       request,
       userId,
       remember,
       redirectTo,
     }: CreateUserSessionProps): Promise<Response>
     ```
   - Details:
     - Extend existing functions to check both legacy and Firebase sessions
     - Maintain API compatibility
     - Add Firebase session creation function
     - Handle session migration scenarios

4. **Update User model for Firebase integration**

   - File: `app/models/user.server.ts`
   - Add functions:
     ```ts
     type CreateUserFromFirebaseProps = {
       firebaseUid: string
       email: string
       displayName?: string | null
     }

     type GetUserByFirebaseUidProps = {
       firebaseUid: string
     }

     type UpdateUserFirebaseDataProps = {
       userId: string
       firebaseUid?: string
       email?: string
       displayName?: string | null
     }

     export async function createUserFromFirebase(
       props: Readonly<CreateUserFromFirebaseProps>
     ): Promise<User>

     export async function getUserByFirebaseUid(
       props: Readonly<GetUserByFirebaseUidProps>
     ): Promise<User | null>

     export async function updateUserFirebaseData(
       props: Readonly<UpdateUserFirebaseDataProps>
     ): Promise<User>
     ```

5. **Tests**
   - File: `app/features/firebase/__tests__/session.server.test.ts` (Vitest)
   - Cases:
     - Valid Firebase token creates proper session
     - Invalid Firebase token returns null
     - User synchronization works correctly
     - Session validation handles edge cases
   - File: `app/features/firebase/__tests__/auth.server.test.ts` (Vitest)
   - Cases:
     - Authentication functions work with Firebase sessions
     - Backward compatibility with legacy sessions
     - Redirect logic functions properly
   - File: `app/utils/__tests__/session.server.test.ts` (Vitest - update existing)
   - Cases:
     - Enhanced functions support both session types
     - Session creation works for Firebase users
     - Migration between session types

# 7) Types & Interfaces (if applicable)

```ts
// app/features/firebase/types.ts
export type FirebaseSessionData = {
  firebaseUid: string
  userId: string
  email: string
  displayName?: string | null
}

export type SessionBridgeResult = {
  user: User
  session: Session
  isNewUser: boolean
}

export type CreateUserSessionProps = {
  request: Request
  userId: string
  remember?: boolean
  redirectTo?: string
}
```

# 8) Acceptance Criteria

## Common Criteria (all tasks)
- All files listed in "End state" section exist and export expected APIs
- **Validation passes**: Run `pnpm validate` and fix all errors before completion
- All unit tests pass locally with `pnpm test:run`
- All E2E tests pass locally with `pnpm test:e2e:run`
- New strings added to all locales in `app/i18n/locales`; English uses title case, all other languages use sentence case following their respective grammar rules

**Testing Workflow**: Follow this cycle strictly:
1. **Validation first** (`pnpm validate`) - must pass before proceeding
2. **Unit tests** (`pnpm test:run`) - if fixes needed, return to step 1
3. **E2E tests** (`pnpm test:e2e:run`) - if fixes needed, return to step 1, then step 2
4. Any code changes require restarting from step 1

## ðŸŽ¯ Feature Task Criteria
- Feature exports clean public API via `app/features/firebase/index.ts`
- Firebase ID tokens can be exchanged for server sessions maintaining SSR compatibility
- Existing route loaders using `requireUserId`/`getUser` work unchanged
- New users from Firebase are automatically created in database with PUBLIC role
- Existing users can be linked with Firebase UIDs
- Session cookies work with both legacy and Firebase authentication
- No breaking changes to existing authentication flows

# 9) Testing Strategy

- Mock Firebase Admin SDK for isolated unit testing
- Test session creation and validation with various token states
- Verify database user synchronization with Firebase user data
- Test backward compatibility with existing session-based authentication
- Include edge cases: expired tokens, invalid tokens, network failures
- Test user role assignment and RBAC integration

# 10) Notes / Links

- Reference PRD section: Phase 1 - Authentication Modernization
- Firebase Auth documentation: https://firebase.google.com/docs/auth/admin/verify-id-tokens
- Next task: TASK-0103 (authentication UX migration)
- Critical: Maintain zero downtime during migration by supporting both session types
- **Architecture Note**: Firebase functionality organized as feature module in `app/features/firebase/` for better code organization and maintainability
