---
description: "Complete group set management (view + assign/move/clear/swap) with tests"
id: "TASK-0301"
title: "Complete group set management with assignment operations and tests"
status: "in-progress"
priority: "P1"
labels: ["feature", "ui", "groups", "tournament", "tests", "rbac", "i18n"]
dependencies: []
created: "2025-10-08"
updated: "2025-10-08"
globs:
alwaysApply: false
---

# Architecture Decision

**Pattern**: üåç **SHARED Task** - Updates shared/global code

**Rationale**: This task modifies shared database models (`app/models/group.server.ts`), creates routes under the admin competition section, and adds i18n strings that are reusable across the application. The group management functionality is a core feature accessible to multiple user roles (ADMIN, MANAGER) and could be used across different parts of the application.

# 1) High-Level Objective

Deliver a complete group set management capability where authorized staff can
view groups and reserve lists for a selected tournament, assign/unassign/move
teams between slots/reserve, and validate behavior with unit and E2E tests.

# 2) Background / Context

**Phase 3 - Groups & Playoffs (MVP)**: This task completes team allocation into
groups for selected tournaments, which is the core "in progress" feature per PRD.
Schema and list/create flows exist, but details management (assignments) and tests
were incomplete. This task fully specifies the implementation and testing to complete
Phase 3's group allocation requirement.

**Competition Section Context**: The Admin Panel includes a "Competition Management"
section at `/a7k9m2x5p8w1n4q6r3y8b5t1/competition` which serves as the hub for
running tournaments. This section currently contains:
- **Groups** (this task - Phase 3) - Team allocation into groups
- **Matches** (Phase 4 - planned) - Match scheduling and scoring
- **Standings** (Phase 4 - planned) - Results and rankings

Already present (baseline):
- Prisma schema for `GroupSet` / `Group` / `GroupSlot` with relations and
  constraints (unique per slot, unique team per set)
- Routes for create/list group sets: `competition.groups.new` and
  `competition.groups`
- Models: `createGroupSet`, `getTournamentGroupSets`,
  `getGroupSetWithDetails`, `getTeamsByCategories`
- Admin Panel link to Competition section (renamed from "Match Management")

# 3) Assumptions & Constraints

- ASSUMPTION: RBAC allows MANAGER and ADMIN to manage groups
- Constraint: Use `requireUserWithPermission(request, 'groups:manage')` in
  loaders/actions (align with ADR-0022)
- Constraint: React Router v7 file-based routes; SSR-compatible loaders/actions
- Constraint: Mobile-first UI; desktop via `lg:` breakpoint; min 44px touch
  targets; accessible labels
- Constraint: TypeScript strict, no `any`; follow code style guide
- Constraint: i18n: all new strings added to all locales; Dutch sentence case
- Constraint: Conventional Commits enforced

# 4) Dependencies (Other Tasks or Artifacts)

- prisma/schema.prisma
- app/models/group.server.ts
- app/routes/a7k9m2x5p8w1n4q6r3y8b5t1/competition/competition.groups.tsx
- app/components/buttons/ActionButton.tsx
- app/components/inputs/TextInputField.tsx
- app/utils/rbacMiddleware.server.ts (reference for permission wrappers)
- app/i18n/locales/*.json (for new strings)

# 5) Context Plan

## üåç SHARED Task Pattern

**Beginning (add to model context, read-only):**
- `prisma/schema.prisma` - Database schema for GroupSet, Group, GroupSlot
- `app/models/group.server.ts` - Existing model functions
- `app/routes/a7k9m2x5p8w1n4q6r3y8b5t1/competition/competition.groups.tsx` - List view
- `app/utils/rbacMiddleware.server.ts` - Permission utilities
- `app/components/buttons/ActionButton.tsx` - Reusable button component
- `app/components/inputs/TextInputField.tsx` - Reusable input component
- `app/i18n/locales/*.json` - Existing translation files

**End state (files that will be created/modified):**
- `app/models/group.server.ts` - Add 4 transactional assignment helpers (`.server.ts` = server-only)
- `app/routes/a7k9m2x5p8w1n4q6r3y8b5t1/competition/competition.groups.$groupSetId.tsx` - New details route with loader/action/UI
- `prisma/seed.js` - Add JO8 group set seed data for Spring Cup
- `app/i18n/locales/*.json` - Add groups-related translation keys (all 6 locales)
- `app/models/__tests__/group.server.test.ts` - New unit tests for assignment functions
- `playwright/pages/GroupsPage.ts` - New Page Object Model
- `playwright/tests/competition.groups.spec.ts` - New E2E test spec
- `docs/development/database.md` - Update with seeded groups documentation (already done)

# 6) Low-Level Steps (Ordered, information-dense)

1) Model functions ‚Äî `app/models/group.server.ts`
   - [ ] Add assignTeamToGroupSlot function with validation
   - [ ] Add clearGroupSlot function
   - [ ] Add moveTeamToReserve function
   - [ ] Add swapGroupSlots function with atomic swap logic

   Implementation details:
     - `assignTeamToGroupSlot(props: Readonly<{ groupSetId: string; groupId:
       string; slotIndex: number; teamId: string }>): Promise<void>`
       - Validate slot existence: belongs to `groupSetId` + `groupId` at
         `slotIndex`
       - If occupied, throw; caller must clear/swap first
       - Clear any previous assignment of `teamId` in same `groupSetId` (group
         or reserve), then set on target slot
     - `clearGroupSlot(props: Readonly<{ groupSlotId: string }>): Promise<void>`
       - Set `teamId: null`
     - `moveTeamToReserve(props: Readonly<{ groupSetId: string; teamId:
       string }>): Promise<void>`
       - Clear any assignment; ensure/create reserve slot (groupId null) and set
         `teamId`
     - `swapGroupSlots(props: Readonly<{ sourceSlotId: string; targetSlotId:
       string }>): Promise<void>`
       - Swap teamIds atomically, respecting unique constraints

2) Details route ‚Äî
   `app/routes/a7k9m2x5p8w1n4q6r3y8b5t1/competition/competition.groups.$groupSetId.tsx`
   - [ ] Create or update competition.groups.$groupSetId.tsx route
   - [ ] Implement loader with permission check and data fetching
   - [ ] Implement action handler for assign/clear/move/swap operations
   - [ ] Create UI with groups display and assignment forms
   - [ ] Add mobile-first responsive layout

   Implementation details:
   - Loader signature: `export async function loader({ request, params }:
     Route.LoaderArgs)`
     - `await requireUserWithPermission(request, 'groups:manage')`
     - Require `params.groupSetId`, `?tournament=<id>`
     - Fetch `groupSet = getGroupSetWithDetails(groupSetId)`
     - Fetch `availableTeams = getTeamsByCategories(tournamentId,
       groupSet.categories)`
     - Return `{ groupSet, availableTeams, tournamentId }`
   - Action signature: `export async function action({ request, params }:
     Route.ActionArgs)`
     - Same permission check
     - Parse `intent` from FormData: `assign | clear | reserve | swap`
       - `assign`: needs `groupId`, `slotIndex` (number), `teamId`
       - `clear`: needs `groupSlotId`
       - `reserve`: needs `teamId`
       - `swap`: needs `sourceSlotId`, `targetSlotId`
     - Call corresponding model helper; redirect back to same URL
   - Component UI:
     - Header with title and back link to `competition/groups?tournament=<id>`
     - Left column: groups list ‚Üí slots cards; each slot shows assigned team or
       an Assign form (TextInputField for `teamId` or a simple select in future)
     - For assigned slots: show Clear button (posts `intent=clear`)
     - Right column: Reserve list and Available teams list with Move-to-reserve
       action
     - Mobile-first layout; `lg:` for 2-column
     - Add i18n keys for headings/buttons/text

3) Seeding ‚Äî `prisma/seed.js`
   - [ ] Verify Spring Cup tournament has 20+ JO8 teams seeded
   - [ ] Confirm NO GroupSets are created in seed (empty state by design)
   - [ ] Document seeding approach in seed file comments

   Notes:
   - **NO GroupSets created in seed** - All tournaments start with empty state
   - Spring Cup tournament has 20+ JO8 teams seeded (for testing)
   - GroupSets are created by users via Competition ‚Üí Groups ‚Üí "Create Group Set" UI
   - This ensures consistent empty state and allows testing the full workflow
   - E2E tests will create GroupSet as part of test scenario (see step 7)

4) i18n ‚Äî add translation keys in all locales under `app/i18n/locales/`
   - [ ] Add group management strings to nl.json
   - [ ] Add group management strings to en.json
   - [ ] Add group management strings to fr.json
   - [ ] Add group management strings to ar.json
   - [ ] Add group management strings to tr.json
   - [ ] Add group management strings to de.json

   Suggested keys (examples; Dutch sentence case):
     - `groups.title`: "Groepenbeheer"
     - `groups.subtitle`: "Beheer teamindelingen"
     - `groups.selectTournament`: "Selecteer een toernooi"
     - `groups.noGroupSets`: "Nog geen groepssets"
     - `groups.createGroupSet`: "Groepsset aanmaken"
     - `groups.categories`: "Categorie√´n"
     - `groups.setup`: "Instellingen"
     - `groups.autofill`: "Automatisch vullen"
     - `groups.created`: "Aangemaakt"
     - `groups.assign`: "Toewijzen"
     - `groups.clear`: "Leegmaken"
     - `groups.reserve`: "Naar reserve"
     - `groups.available`: "Beschikbare teams"

5) RBAC ‚Äî enforce permission checks (server)
   - [ ] Update details route to use requireUserWithPermission(request, 'groups:manage')
   - [ ] Verify existing admin-only check on listing route
   - [ ] Test that MANAGER role can access group management
   - [ ] Test that PUBLIC/REFEREE roles cannot access group management

6) Unit tests ‚Äî `app/models/__tests__/group.server.test.ts`
   - [ ] Create or update group.server.test.ts
   - [ ] Add test for assigning team to empty slot
   - [ ] Add test for reassigning team (clears previous assignment)
   - [ ] Add test for clearing a slot
   - [ ] Add test for moving team to reserve
   - [ ] Add test for swapping two occupied slots
   - [ ] Add test for constraint violations (error cases)
   - [ ] Run tests: `pnpm test:run`

7) E2E tests ‚Äî Playwright
   - [ ] Create or update playwright/pages/GroupsPage.ts (Page Object Model)
   - [ ] Create or update playwright/tests/competition.groups.spec.ts
   - [ ] Add test for creating group set with form
   - [ ] Add test for verifying group set appears in list
   - [ ] Add test for opening group set details
   - [ ] Add test for assigning team to slot
   - [ ] Add test for moving team to reserve then assigning
   - [ ] Add test for clearing a slot
   - [ ] Add test for swapping two slots
   - [ ] Add test for persistence (reload and verify)
   - [ ] Run E2E tests: `pnpm test:e2e:run`

   Implementation details:
   - POM: `playwright/pages/GroupsPage.ts`
     - Methods: `goto(tournamentId)`, `createGroupSet(name, config)`,
       `openGroupSet(name)`, `assignTeam(slotLabelOrIndex, teamId)`,
       `clearSlot(slotLabelOrIndex)`, `moveTeamToReserve(teamName)`,
       `assertAssignment(...)`, etc.
   - Spec: `playwright/tests/competition.groups.spec.ts`
     - Auth bypass per E2E strategy
     - Navigate to Competition ‚Üí Groups, select Spring Cup tournament
     - **Create GroupSet**: Click "Create Group Set", fill form:
       - Name: "Group Stage (JO8)"
       - Categories: JO8
       - Groups: 4, Slots: 5
       - Auto-fill: enabled
     - Verify GroupSet created and appears in list
     - Open `Group Stage (JO8)` details
     - Verify 4 groups √ó 5 empty slots, reserve has teams
     - Assign one JO8 team to Group A slot 0; verify
     - Move another JO8 team to Reserve; assign to Group A slot 1; verify
     - Clear a slot; verify
     - Swap two occupied slots; verify
     - Reload and verify persistence

8) Performance & UX
   - [ ] Keep forms simple without drag-and-drop for MVP
   - [ ] Consider adding prefetching on hover/intent
   - [ ] Ensure proper focus states for all interactive elements
   - [ ] Test keyboard navigation through all forms

9) Accessibility
   - [ ] Add proper labels for all form controls
   - [ ] Add ARIA attributes where needed
   - [ ] Verify all buttons are keyboard accessible
   - [ ] Test visible focus rings on all interactive elements

10) Commit & PR guidelines
   - [ ] Use Conventional Commits format (e.g., `feat(groups): add assignment actions`)
   - [ ] Include screenshots of details page in PR description

# 7) Types & Interfaces

## Existing Types (from `app/models/group.server.ts`)

Reuse these existing types - no modifications needed:

```ts
// Already defined in app/models/group.server.ts
type GroupSetWithDetails = {
  id: string
  name: string
  categories: Category[]
  configGroups: number
  configSlots: number
  autoFill: boolean
  createdAt: Date
  groups: GroupWithSlots[]
  reserveSlots: GroupSlotWithTeam[]
}

type GroupWithSlots = {
  id: string
  name: string
  order: number
  slots: GroupSlotWithTeam[]
}

type GroupSlotWithTeam = {
  id: string
  slotIndex: number
  team: {
    id: string
    name: string
    clubName: string
    category: Category
  } | null
}

type UnassignedTeam = {
  id: string
  name: string
  clubName: string
  category: Category
}
```

## New Function Props Types (to be added in `app/models/group.server.ts`)

Follow TypeScript conventions - use `type` instead of `interface`, `Readonly<>` for props:

```ts
type AssignTeamToGroupSlotProps = {
  readonly groupSetId: string
  readonly groupId: string
  readonly slotIndex: number
  readonly teamId: string
}

type ClearGroupSlotProps = {
  readonly groupSlotId: string
}

type MoveTeamToReserveProps = {
  readonly groupSetId: string
  readonly teamId: string
}

type SwapGroupSlotsProps = {
  readonly sourceSlotId: string
  readonly targetSlotId: string
}
```

## Route Types

```ts
// Loader data type for details route
type LoaderData = {
  readonly groupSet: GroupSetWithDetails
  readonly availableTeams: readonly UnassignedTeam[]
  readonly tournamentId: string
}

// Action data type for error handling
type ActionData = {
  readonly error?: string
}
```

## FormData Keys

Action FormData keys (all strings):
- `intent`: `"assign" | "clear" | "reserve" | "swap"`
- `groupId`: string (group ID for assign intent)
- `slotIndex`: string (number as string for assign intent)
- `teamId`: string (team ID for assign/reserve intents)
- `groupSlotId`: string (slot ID for clear intent)
- `sourceSlotId`: string (source slot ID for swap intent)
- `targetSlotId`: string (target slot ID for swap intent)

# 8) Acceptance Criteria

## Common Criteria (Required for all tasks)

- All files listed in "End state" section exist and export expected APIs
- **Validation passes**: Run `pnpm validate` and fix all errors before completion
  - TypeScript compilation succeeds with no errors
  - ESLint passes with no errors
  - Prettier formatting is correct
- All unit tests pass locally with `pnpm test:run`
- All E2E tests pass locally with `pnpm test:e2e:run`
- New i18n strings added to **all 6 locales** in `app/i18n/locales/`:
  - English (`en.json`) - uses title case
  - Dutch (`nl.json`) - uses sentence case
  - German (`de.json`) - uses sentence case
  - French (`fr.json`) - uses sentence case
  - Turkish (`tr.json`) - uses sentence case
  - Arabic (`ar.json`) - uses sentence case

**Testing Workflow**: Follow this cycle strictly:
1. **Validation first** (`pnpm validate`) - must pass before proceeding
2. **Unit tests** (`pnpm test:run`) - if fixes needed, return to step 1
3. **E2E tests** (`pnpm test:e2e:run`) - if fixes needed, return to step 1, then step 2
4. Any code changes require restarting from step 1

## üåç Shared Task Criteria

- Components are reusable and don't contain feature-specific logic
- Shared utilities can be imported by multiple features
- No breaking changes to existing feature imports
- TypeScript conventions followed (use `type`, no semicolons, no `any`)

## Feature-Specific Criteria

- Details page reachable at `/a7k9m2x5p8w1n4q6r3y8b5t1/competition/groups/:groupSetId?tournament=<id>`
- Loader and action enforce `groups:manage` permission; unauthorized users get 403
- UI displays:
  - Groups with ordered slots (4 groups √ó 5 slots = 20 total)
  - Reserve list with assigned teams
  - Available teams list (unassigned teams)
- All 4 operations work correctly:
  - **Assign**: Move team from available/reserve to group slot
  - **Clear**: Remove team from group slot back to available
  - **Reserve**: Move team to reserve list
  - **Swap**: Exchange teams between two slots
- Operations persist to database and reflect immediately after redirect
- Mobile-first responsive layout works on small screens
- Desktop layout (‚â•1024px) shows 3-column grid (`lg:grid-cols-3`)
- All interactive elements meet 44px minimum touch target size
- Keyboard navigation works for all forms and buttons
- Focus states visible with proper focus rings
- Model functions are transactional (use `prisma.$transaction`)
- Seeded data includes JO8 group set with empty slots and filled reserve
- Unit test coverage ‚â•70% for new model functions
- E2E tests cover full user workflows with auth bypass
- Page Object Model pattern used for E2E tests

# 9) Testing Strategy

## Common Testing Approach

- Create unit tests with Vitest that verify component behavior and rendering
- Create E2E tests with Playwright using Page Object Model pattern
- Include database seeding for realistic test data
- Test responsive design on different screen sizes
- Test accessibility with keyboard navigation
- Avoid testing implementation details - focus on user-facing behavior
- Follow the testing workflow cycle: validation ‚Üí unit ‚Üí E2E ‚Üí repeat if fixes needed

## üåç Shared Task Testing

- Test component reusability across different contexts
- Mock external dependencies to ensure pure functionality
- Verify no state leakage between tests (reset database between tests)

## Unit Tests (`app/models/__tests__/group.server.test.ts`)

**Setup:**
- Use existing Vitest test harness
- Set up test database with in-memory SQLite
- Seed minimal test data (tournament, teams, group set)

**Test Cases:**
1. **Assign team to empty slot**
   - Create group set with empty slots
   - Assign team to specific slot
   - Verify team is assigned and previous assignment cleared
2. **Reassign team to different slot**
   - Assign team to slot A
   - Reassign same team to slot B
   - Verify team moved from A to B (A is now empty)
3. **Clear a slot**
   - Assign team to slot
   - Clear the slot
   - Verify slot is empty and team is unassigned
4. **Move team to reserve**
   - Assign team to group slot
   - Move team to reserve
   - Verify team is in reserve and group slot is empty
5. **Swap two occupied slots**
   - Assign team A to slot 1
   - Assign team B to slot 2
   - Swap slots 1 and 2
   - Verify team A is in slot 2 and team B is in slot 1
6. **Error: assign to occupied slot**
   - Assign team A to slot
   - Attempt to assign team B to same slot
   - Verify error is thrown
7. **Error: slot not found**
   - Attempt to assign team to non-existent slot
   - Verify error is thrown

## E2E Tests (`playwright/tests/competition.groups.spec.ts`)

**Setup:**
- Use auth bypass per E2E strategy
- Use seeded JO8 group set from seed.js
- Create Page Object Model (`playwright/pages/GroupsPage.ts`)

**Page Object Model Methods:**
```ts
class GroupsPage {
  async goto(tournamentId: string): Promise<void>
  async selectTournament(tournamentName: string): Promise<void>
  async openGroupSet(name: string): Promise<void>
  async assignTeamToSlot(groupName: string, slotIndex: number, teamId: string): Promise<void>
  async clearSlot(groupName: string, slotIndex: number): Promise<void>
  async moveTeamToReserve(teamId: string): Promise<void>
  async getSlotTeamName(groupName: string, slotIndex: number): Promise<string | null>
  async getReserveTeams(): Promise<string[]>
  async getAvailableTeams(): Promise<string[]>
}
```

**Test Scenarios:**
1. **Navigate to groups page**
   - Visit admin dashboard
   - Click Competition ‚Üí Groups
   - Select Spring Cup tournament
   - Verify empty state: "No group sets yet"
2. **Create group set**
   - Click "Create Group Set" button (top-right)
   - Fill form: Name "Group Stage (JO8)", Categories: JO8, Groups: 4, Slots: 5, Auto-fill: enabled
   - Submit form
   - Verify redirect to groups list
   - Verify "Group Stage (JO8)" appears in list
3. **Open group set details**
   - Click "Group Stage (JO8)"
   - Verify 4 groups displayed (A, B, C, D)
   - Verify each group has 5 empty slots
   - Verify reserve list has JO8 teams (from auto-fill)
   - Verify available teams list exists
4. **Assign team to group slot**
   - Select team from available list
   - Assign to Group A, slot 0
   - Verify team appears in slot
   - Verify team removed from available list
5. **Clear slot**
   - Click Clear button on assigned slot
   - Verify slot is empty
   - Verify team returns to available list
6. **Move team to reserve**
   - Click "Move to reserve" on available team
   - Verify team appears in reserve list
   - Verify team removed from available list
7. **Assign from reserve to group**
   - Take team from reserve
   - Assign to Group B, slot 0
   - Verify team in group slot
   - Verify team removed from reserve
8. **Persistence check**
   - Perform assignment
   - Reload page
   - Verify assignment persists

## Coverage Target

- Maintain project threshold: ‚â•70% code coverage
- Focus on critical paths: assignment operations and error handling
- All model functions must have unit tests
- All user-facing workflows must have E2E tests

# 10) Notes / Links

- See ADR-0022 (RBAC), ADR-0025 (Competition Section), and PRD Phase 3 (Groups & Playoffs)
- Consider future enhancement: DnD UI and auto-seeding algorithms
