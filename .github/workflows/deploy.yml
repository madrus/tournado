name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      - dev
  pull_request:
    types:
      - closed
    branches:
      - main
      - dev

# Ensure only one deployment workflow runs at a time per branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: write
  contents: read
  deployments: write
  id-token: write

jobs:
  deploy:
    name: 🚀 Deploy
    # Only run if the CI workflow was successful
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || 
      (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.workflow_run.head_branch == 'main' && 'production' || 'staging' }}
      url: ${{ github.event.workflow_run.head_branch == 'main' && 'https://tournado.fly.dev' || 'https://tournado-staging.fly.dev' }}
    permissions:
      contents: read
      deployments: write
      id-token: write

    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.event.pull_request.head.ref }}

      - name: 👀 Read app name
        uses: SebRollen/toml-action@v1.2.0
        id: app_name
        with:
          file: fly.toml
          field: app

      - name: 🎈 Setup Fly
        uses: superfly/flyctl-actions/setup-flyctl@v1
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: 🚀 Deploy Staging
        if: ${{ github.event.workflow_run.head_branch == 'dev' || github.event.pull_request.head.ref == 'dev' }}
        run: |
          echo "${{ secrets.FLY_API_TOKEN }}" > /tmp/fly_token
          # Deploy using Fly.io's standard deployment process with rolling updates
          flyctl deploy --remote-only \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --app ${{ steps.app_name.outputs.value }}-staging \
            --access-token "$(cat /tmp/fly_token)" \
            --strategy rolling \
            --max-unavailable 0.33 \
            --wait-timeout 5m \
            --yes

      - name: 🚀 Deploy Production
        if: ${{ github.event.workflow_run.head_branch == 'main' || github.event.pull_request.head.ref == 'main' }}
        run: |
          echo "${{ secrets.FLY_API_TOKEN }}" > /tmp/fly_token
          # Deploy using Fly.io's standard deployment process with rolling updates
          flyctl deploy --remote-only \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --app ${{ steps.app_name.outputs.value }} \
            --access-token "$(cat /tmp/fly_token)" \
            --strategy rolling \
            --max-unavailable 0.33 \
            --wait-timeout 5m \
            --yes
